name: CI

on:
  push:
    branches: [ main ]
    paths:
      - 'charts/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'charts/**'

permissions:
  contents: write

jobs:
  # Basic chart validation
  setup:
    uses: ./.github/workflows/setup-environment.yml
    with:
      helm-version: '3.18.4'
      install-ct: true
      fetch-depth: 0

  # Chart linting and testing using reusable workflow
  lint-test:
    name: Lint and Test Charts
    uses: ./.github/workflows/validate-chart.yml
    strategy:
      matrix:
        chart: [cert-manager, ingress-nginx, grafana-observability, n8n, unbound]
    with:
      chart-name: ${{ matrix.chart }}
      chart-path: charts/${{ matrix.chart }}

  # # Chart testing with ct using reusable workflow
  # chart-test:
  #   name: Chart Testing
  #   uses: ./.github/workflows/test-charts-ct.yml
  #   with:
  #     config-file: .github/ct.yaml
  #     test-type: both

  chart-release:
    name: Release Charts
    uses: ./.github/workflows/helm-release.yml
    needs: [validate, lint-test, chart-test]
