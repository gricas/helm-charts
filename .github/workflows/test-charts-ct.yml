name: Test Charts with CT

on:
  workflow_call:
    inputs:
      config-file:
        description: 'Path to ct configuration file'
        required: false
        default: '.github/ct.yaml'
        type: string
      helm-version:
        description: 'Helm version to use'
        required: false
        default: '3.18.4'
        type: string
      test-type:
        description: 'Type of test to run (lint, install, or both)'
        required: false
        default: 'both'
        type: string

jobs:
  setup:
    uses: ./.github/workflows/setup-environment.yml
    with:
      helm-version: ${{ inputs.helm-version }}
      install-ct: true
      fetch-depth: 0

  test:
    name: Test Charts with CT
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ inputs.helm-version }}

      - name: Install chart-testing and setup PATH
        run: |
          echo "ğŸ”§ Installing chart-testing..."

          # Install chart-testing
          go install github.com/helm/chart-testing/v3/ct@latest

          # Add to PATH for this job
          echo "$HOME/go/bin" >> $GITHUB_PATH

          # Verify installation
          $HOME/go/bin/ct version

      - name: Create kind cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: helm-test
          kubectl_version: v1.28.0

      - name: Add Helm repositories
        run: |
          echo "ğŸ“¦ Adding Helm repositories..."
          helm repo add jetstack https://charts.jetstack.io
          helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update

      - name: Lint charts
        if: inputs.test-type == 'lint' || inputs.test-type == 'both'
        run: |
          echo "ğŸ” Linting charts with ct..."
          ct lint --all --config ${{ inputs.config-file }} || echo "No charts to lint"

      - name: Test charts
        if: inputs.test-type == 'install' || inputs.test-type == 'both'
        run: |
          echo "ğŸ§ª Testing charts with ct..."
          ct install --all --config ${{ inputs.config-file }} || echo "No charts to test"
